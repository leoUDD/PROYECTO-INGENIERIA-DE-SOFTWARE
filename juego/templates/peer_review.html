{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Misión Emprende UDD — Evaluación de Proyectos</title>

  <link rel="stylesheet" href="{% static 'css/estilo_peer_review.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm peer-card">
        <div class="card-body">
          <h1 class="h4 mb-2">Evaluación de Proyectos</h1>

          <p class="text-muted mb-3">
            Sesión:
            <strong>{{ session.nombre }}</strong>
            · Tu equipo:
            <strong>{{ evaluator_team.nombregrupo }}</strong><br>
            Evalúa a los demás equipos de forma honesta y respetuosa. No puedes evaluarte a ti mismo.
          </p>

          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'info' }} mb-2">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}

          {% if submitted %}
            <div class="alert alert-success mb-3">
              ¡Listo! Tu equipo ya evaluó a todos los otros equipos de la sesión.
            </div>

            <p class="text-muted mb-3 small">
              Gracias por tu aporte. Tus evaluaciones serán consideradas para el ranking final
              y el profesor podrá revisarlas en detalle.
            </p>

            <a href="{% url 'mision_cumplida' %}" class="btn btn-primary">
              Continuar
            </a>
            <a href="{% url 'transicionapoyo' %}" class="btn btn-outline-secondary ms-2">
              Volver al juego
            </a>

          {% else %}
            <p class="text-muted small mb-3">
              Ya evaluaste a <strong>{{ evaluados_count }}</strong> de
              <strong>{{ total_targets }}</strong> equipos.
              {% if total_targets > evaluados_count %}
                Te faltan <strong>{{ total_targets|add:"-evaluados_count" }}</strong> equipos por evaluar.
              {% endif %}
            </p>

            <form method="post">
              {% csrf_token %}
              <div class="mb-4">
                <label class="form-label fw-semibold">
                  Reflexión final (opcional)
                </label>
                <textarea
                  name="reflection"
                  rows="3"
                  class="form-control"
                  maxlength="500"
                  placeholder="¿Qué aprendiste de los proyectos presentados?"
                ></textarea>
                <div class="form-text">Máx. 500 caracteres.</div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Equipo a evaluar</label>
                <select name="target_team_id" class="form-select" required>
                  <option value="" selected disabled>Selecciona un equipo</option>
                  {% for team in target_teams %}
                    <option value="{{ team.idgrupo }}">
                      {{ team.nombregrupo }}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">
                  Solo se muestran los equipos que aún no has evaluado.
                </div>
              </div>

              <div class="border rounded p-3 mb-3">
                <h2 class="h6 mb-3">
                  Criterios (1 = muy bajo, 5 = excelente)
                </h2>

                {% for c in criteria %}
                  <div class="mb-3">
                    <label class="form-label d-block">
                      {{ c.label }}
                    </label>
                    <div class="d-flex gap-2 flex-wrap">
                      {% for v in "12345" %}
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="score_{{ c.key }}"
                            id="score_{{ c.key }}_{{ v }}"
                            value="{{ v }}"
                            required
                          >
                          <label
                            class="form-check-label"
                            for="score_{{ c.key }}_{{ v }}"
                          >
                            {{ v }}
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">
                  Comentario para el equipo
                </label>
                <textarea
                  name="comment"
                  rows="3"
                  class="form-control"
                  maxlength="600"
                  placeholder="Fortalezas y sugerencias concretas…"
                  required
                ></textarea>
              </div>

              <!-- Confirmación -->
              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="confirm_honesty"
                  name="confirm_honesty"
                  required
                >
                <label class="form-check-label" for="confirm_honesty">
                  Confirmo que esta evaluación es honesta y no corresponde a mi propio equipo.
                </label>
              </div>

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                  Enviar evaluación
                </button>
                <a href="{% url 'transicionapoyo' %}" class="btn btn-outline-secondary">
                  Cancelar
                </a>
              </div>
            </form>
          {% endif %}

          <hr class="my-4">

          <div class="small text-muted">
            <strong>Reglas:</strong>
            1) No evalúes a tu propio equipo.
            2) El profesor ve todas las evaluaciones.
            3) Debes evaluar a todos los otros equipos de tu sesión.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
