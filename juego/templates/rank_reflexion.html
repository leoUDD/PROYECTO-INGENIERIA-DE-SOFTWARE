{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Misi√≥n Emprende UDD ‚Äî Resultados</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/estilo_rank_reflexion.css' %}">
</head>
<body>
  <main class="results-wrap" role="main" aria-labelledby="page-title">

    <!-- ===== ENCABEZADO ===== -->
    <section class="results-hero">
      <header class="page-header">
        <div class="head-text">
          <h1 id="page-title">Resultados del Juego</h1>
          <p class="subtitle">Ranking por cantidad de <strong>TOKENS</strong> obtenidos</p>
        </div>
      </header>
    </section>

    <!-- ===== TABLA DE RESULTADOS ===== -->
    <section class="card card-ranking" aria-label="Tabla de equipos y tokens">
      <div class="table-wrap">
        <table id="tablaResultados" class="results-table">
          <thead>
            <tr>
              <th scope="col" class="col-rank">#</th>
              <th scope="col">Equipo</th>
              <th scope="col" class="col-tokens">Tokens</th>
            </tr>
          </thead>
          <tbody>
            {% for t in teams %}
            <tr>
              <td class="rank" data-rank="{{ forloop.counter }}">{{ forloop.counter }}</td>
              <td class="team">{{ t.name }}</td>
              <td class="tokens" data-tokens="{{ t.tokens }}">{{ t.tokens }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="empty">A√∫n no hay resultados para mostrar.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="note">* En caso de empate en tokens, se comparte la misma medalla.</p>
    </section>

    <!-- ===== REFLEXI√ìN FINAL ===== -->
    <section class="card card-reflexion" aria-label="Reflexi√≥n final">
      <h2 class="h2">Reflexi√≥n final del juego</h2>
      <p class="reflection">
        {{ reflexion_final|default:"El emprendimiento se fortalece cuando el equipo comparte una visi√≥n, se apoya con feedback honesto y convierte los aprendizajes en pr√≥ximos pasos concretos. ¬øQu√© se llevan de esta experiencia?" }}
      </p>
    </section>

    <!-- ===== C√ìDIGOS QR ===== -->
    <section class="qr-grid" aria-label="C√≥digos QR finales">
      <article class="card card-instagram qr-card">
        <h3 class="h3">Instagram</h3>
        <div class="qr-box">
          <img src="{% static 'images/qr_insta.png' %}" alt="C√≥digo QR Instagram Misi√≥n Emprende" />
        </div>
        <p class="qr-hint">S√≠guenos en instagram</p>
      </article>

      <article class="card card-evaluacion qr-card">
        <h3 class="h3">Evaluaci√≥n de la Actividad</h3>
        <div class="qr-box">
          <img src="{% static 'images/qr_evaluacion.png' %}" alt="C√≥digo QR Evaluaci√≥n de la actividad" />
        </div>
        <p class="qr-hint">Tu opini√≥n nos ayuda a mejorar futuras misiones.</p>
      </article>
    </section>
  </main>

  <!-- ===== SCRIPT: Ordenar y asignar medallas ===== -->
  <script>
  (function() {
    const table = document.getElementById('tablaResultados');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.querySelector('.tokens'));
    if (!rows.length) return;

    // Ordenar por tokens (desc)
    rows.sort((a, b) => {
      const ta = parseInt(a.querySelector('.tokens')?.dataset.tokens || '0', 10);
      const tb = parseInt(b.querySelector('.tokens')?.dataset.tokens || '0', 10);
      return tb - ta;
    });

    const tokensPerRow = rows.map(r => parseInt(r.querySelector('.tokens').dataset.tokens || '0', 10));
    const uniqueTokens = [...new Set(tokensPerRow)];

    const medalForTokens = new Map();
    let rank = 1;
    let idx = 0;

    for (let i = 0; i < uniqueTokens.length; i++) {
      const tok = uniqueTokens[i];
      let countSame = 0;
      while (idx + countSame < tokensPerRow.length && tokensPerRow[idx + countSame] === tok) {
        countSame++;
      }

      let medalClass = null, medalEmoji = null, rowClass = null;
      if (rank === 1) { medalClass = 'medal medal-1'; medalEmoji = 'ü•á'; rowClass = 'top1'; }
      else if (rank === 2) { medalClass = 'medal medal-2'; medalEmoji = 'ü•à'; rowClass = 'top2'; }
      else if (rank === 3) { medalClass = 'medal medal-3'; medalEmoji = 'ü•â'; rowClass = 'top3'; }

      medalForTokens.set(tok, { rank, medalClass, medalEmoji, rowClass });

      idx += countSame;
      rank += countSame;
    }

    rows.forEach(r => {
      const rankCell = r.querySelector('.rank');
      const tok = parseInt(r.querySelector('.tokens').dataset.tokens || '0', 10);
      const info = medalForTokens.get(tok);
      if (!rankCell) return;
      rankCell.textContent = '';

      const num = document.createElement('span');
      num.textContent = info ? String(info.rank) : String(uniqueTokens.indexOf(tok) + 1);

      if (info && info.medalClass) {
        const medal = document.createElement('span');
        medal.className = info.medalClass;
        medal.textContent = info.medalEmoji;
        rankCell.appendChild(medal);
        if (info.rowClass) r.classList.add(info.rowClass);
      }

      rankCell.appendChild(num);
      tbody.appendChild(r);
    });
  })();
  </script>
</body>
</html>
