{% load static %}
{% include "atajos.html" %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MisiÃ³n Emprende UDD â€” Bubble Map</title>
  <link rel="stylesheet" href="{% static 'css/estilo_bubblemap.css' %}">
</head>
<body>
  <main class="bubblemap-container">
    <h1>ðŸ’­ Bubble Map â€” Genera tus ideas</h1>
    <p class="subtitle">Escribe palabras clave relacionadas con tu persona del desafÃ­o.</p>

    {% include "desafio_badge.html" %}

    <section class="bubbles">
      <div class="bubble central">
        <img src="{% static 'images/personas.png' %}" alt="Persona" />
      </div>

      <div class="bubble"><textarea placeholder="Â¿QuÃ© le gusta?"></textarea></div>
      <div class="bubble"><textarea placeholder="Â¿QuÃ© siente?"></textarea></div>
      <div class="bubble"><textarea placeholder="Â¿QuÃ© obstÃ¡culos tiene?"></textarea></div>
      <div class="bubble"><textarea placeholder="Â¿QuÃ© dicen los demÃ¡s?"></textarea></div>
      <div class="bubble"><textarea placeholder="Hobbies"></textarea></div>
      <div class="bubble"><textarea placeholder="Otros"></textarea></div>
    </section>

    <footer class="footer-actions">
      <button id="btnContinuar" class="btn primary">Continuar</button>
    </footer>
  </main>

  <!-- ===========================
       SISTEMA DE GUARDADO + BORRADO
       =========================== -->
  <script>
    const STORAGE_KEY = "bubblemap_data";
    const SESSION_KEY = "browser_session_id";

    // ðŸ‘‰ Fallback para navegadores que NO soportan crypto.randomUUID()
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // 1) Generamos un ID Ãºnico por pestaÃ±a
    const currentSession = sessionStorage.getItem("my_session_id") ||
      (
        window.crypto && typeof window.crypto.randomUUID === "function"
          ? window.crypto.randomUUID()
          : uuidv4()
      );

    sessionStorage.setItem("my_session_id", currentSession);

    // 2) Leemos el Ãºltimo ID guardado en localStorage
    const lastSession = localStorage.getItem(SESSION_KEY);

    // 3) Si NO coincide â†’ el navegador fue cerrado â†’ Borrar data
    if (lastSession && lastSession !== currentSession) {
      localStorage.removeItem(STORAGE_KEY);
    }

    // 4) Guardamos esta sesiÃ³n como "Ãºltima sesiÃ³n activa"
    localStorage.setItem(SESSION_KEY, currentSession);


    /* ========= GUARDAR DATOS ========= */

    const bubbles = document.querySelectorAll(".bubble textarea");

    // Restaurar si existe
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    bubbles.forEach((area, i) => {
      if (saved[i]) area.value = saved[i];
    });

    // Guardar al escribir
    bubbles.forEach((area, i) => {
      area.addEventListener("input", () => {
        const data = {};
        bubbles.forEach((a, idx) => data[idx] = a.value.trim());
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      });
    });

    // BotÃ³n siguiente
    document.getElementById("btnContinuar").addEventListener("click", () => {
      window.location.href = "{% url 'transicioncreatividad' %}";
    });
  </script>
</body>
</html>
