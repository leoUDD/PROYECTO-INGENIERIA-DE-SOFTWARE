{% load static %}
{% include "atajos.html" %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Misi√≥n Emprende UDD ‚Äî Desaf√≠os</title>
  <link rel="stylesheet" href="{% static 'css/estilo_desafios.css' %}">
</head>
<body>
  <main class="selector-container" role="main" aria-labelledby="page-title">
    <header class="header">
      <h1 id="page-title">{{ theme.title|default:slug|title }}</h1>
      <p class="subtitle">{{ theme.hero }}</p>
    </header>
    <section class="challenges-grid" aria-label="Desaf√≠os disponibles">
      {% for challenge in theme.challenges %}
      <article class="challenge-card" tabindex="0"
               data-id="{{ challenge.id }}"
               data-title="{{ challenge.name }}"
               data-desc="{{ challenge.desc }}"
               data-emoji="{{ challenge.emoji|default:'üéØ' }}"
               data-url="{% url 'market' %}"
               data-slug="{{ slug }}">
        <div class="content">
          <h2 class="title">{{ challenge.name }}</h2>
          <p class="desc">{{ challenge.summary|default:challenge.desc }}</p>
        </div>
        <div class="actions">
          <button class="btn select" type="button">Elegir</button>
        </div>
      </article>
      {% endfor %}
    </section>

    <footer class="footer-actions">
      <button id="btnContinuar" class="btn primary" disabled>Comenzar desaf√≠o</button>
    </footer>
  </main>
  <form id="formDesafio" method="post" action="{% url 'transicionempatia' %}">
    {% csrf_token %}
    <input type="hidden" name="desafio_id" id="desafio_id">
  </form>
  <script>
    const KEY = 'desafioSeleccionado';

    // Marca visual un card como seleccionado y actualiza su bot√≥n
    function marcarSeleccion(card) {
      document.querySelectorAll('.challenge-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      document.querySelectorAll('.challenge-card .btn.select').forEach(b => {
        b.textContent = 'Elegir';
        b.disabled = false;
        b.classList.remove('selected');
      });
      const b = card.querySelector('.btn.select');
      if (b) {
        b.textContent = 'Seleccionado ‚úÖ';
        b.disabled = true;
        b.classList.add('selected');
      }
      const btnContinuar = document.getElementById('btnContinuar');
      if (btnContinuar) btnContinuar.disabled = false;
    }

    // Guarda en sessionStorage con la estructura usada por el badge
    function guardarDesafioDesdeCard(card) {
      const data = {
        slug: card.dataset.slug || '',
        titulo: card.dataset.title || 'Desaf√≠o',
        emoji: card.dataset.emoji || 'üéØ',
        resumen: card.dataset.desc || '',
        url: card.dataset.url || '#',
        id: card.dataset.id || null
      };
      try { sessionStorage.setItem(KEY, JSON.stringify(data)); 
      } catch (e) {
        console.warn('No se pudo guardar el desaf√≠o seleccionado en sessionStorage', e);
      }

      const hidden = document.getElementById('desafio_id');
      if (hidden) {
        hidden.value = data.id;
      }
      marcarSeleccion(card);
    }

    // Click en bot√≥n "Elegir"
    document.querySelectorAll('.challenge-card .btn.select').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const card = e.currentTarget.closest('.challenge-card');
        if (card) {
          guardarDesafioDesdeCard(card);
        }
      });
    });

    // Selecci√≥n con Enter sobre la tarjeta
    document.querySelectorAll('.challenge-card').forEach(card => {
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          guardarDesafioDesdeCard(card);
        }
      });
      // Tambi√©n permite seleccionar haciendo click en cualquier parte de la tarjeta
      card.addEventListener('click', (e) => {
        if (!e.target.classList.contains('btn')) {
          guardarDesafioDesdeCard(card);
        }
      });
    });

    // Restaurar selecci√≥n previa (si recargas esta vista)
    (function restoreSelection(){
      let saved = null;
      try { saved = JSON.parse(sessionStorage.getItem(KEY) || 'null');
       } catch (_) {
        saved = null;
       }
      if (!saved || !saved.id) return;
      const card = document.querySelector(`.challenge-card[data-id="${saved.id}"]`);
      if (card) {
        marcarSeleccion(card);
        const hidden = document.getElementById('desafio_id');
        if (hidden) hidden.value = saved.id;
      }
    })();

    // Navegar al siguiente paso
    document.getElementById('btnContinuar').addEventListener('click', () => {
      const hidden = document.getElementById('desafio_id');
      if (hidden && !hidden.value) {
        alert('Por favor, selecciona un desaf√≠o antes de continuar.');
        return;
      }
      document.getElementById('formDesafio').submit();
    });
  </script>
</body>
</html>
